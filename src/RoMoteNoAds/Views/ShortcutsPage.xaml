<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RoMoteNoAds.ViewModels"
             xmlns:models="clr-namespace:RoMoteNoAds.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="RoMoteNoAds.Views.ShortcutsPage"
             x:DataType="vm:ShortcutsViewModel"
             Title="Shortcuts">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="{Binding IsEditing, Converter={toolkit:BoolToObjectConverter TrueObject='Done', FalseObject='Edit'}}"
                     Command="{Binding ToggleEditingCommand}" />
        <ToolbarItem Text="Add"
                     Command="{Binding OpenEditorCommand}"
                     IconImageSource="plus" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="*"
          Padding="{OnIdiom Phone='16', Default='24'}">

        <!-- Shortcuts Grid - Adaptive columns -->
        <CollectionView ItemsSource="{Binding Shortcuts}">
            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Spacing="16"
                                     Padding="32">
                    <Label Text="⚡"
                           FontSize="64"
                           HorizontalOptions="Center" />
                    <Label Text="No Shortcuts"
                           Style="{StaticResource TitleLabel}"
                           HorizontalOptions="Center" />
                    <Label Text="Add shortcuts for quick access to your favorite channels"
                           Style="{StaticResource SubtitleLabel}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center" />
                    <Button Text="Add Shortcut"
                            Command="{Binding OpenEditorCommand}"
                            Style="{StaticResource PrimaryButton}"
                            HorizontalOptions="Center" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical"
                                 Span="{OnIdiom Phone=3, Tablet=5, Desktop=6}"
                                 HorizontalItemSpacing="{OnIdiom Phone=12, Default=16}"
                                 VerticalItemSpacing="{OnIdiom Phone=12, Default=16}" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Shortcut">
                    <Grid Padding="4">
                        <Frame Style="{StaticResource CardFrame}"
                               Padding="12"
                               HeightRequest="{OnIdiom Phone=100, Default=120}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ShortcutsViewModel}}, Path=ExecuteShortcutCommand}"
                                    CommandParameter="{Binding .}" />
                            </Frame.GestureRecognizers>

                            <Grid RowDefinitions="*,Auto">
                                <!-- Channel Icon -->
                                <Grid Grid.Row="0" HorizontalOptions="Center" VerticalOptions="Center">
                                    <Border StrokeThickness="0"
                                            HeightRequest="{OnIdiom Phone=48, Default=56}"
                                            WidthRequest="{OnIdiom Phone=48, Default=56}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>
                                        <Image Source="{Binding IconSource}"
                                               Aspect="AspectFit"
                                               IsVisible="{Binding IconSource, Converter={toolkit:IsNotNullConverter}}" />
                                    </Border>
                                    <!-- Fallback icon if no image -->
                                    <Label Text="⚡"
                                           FontSize="32"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding IconSource, Converter={toolkit:IsNullConverter}}" />
                                </Grid>

                                <!-- Name -->
                                <Label Grid.Row="1"
                                       Text="{Binding Name}"
                                       Style="{StaticResource BodyLabel}"
                                       FontSize="{OnIdiom Phone=12, Default=13}"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"
                                       MaxLines="1"
                                       LineBreakMode="TailTruncation" />

                                <!-- Delete Button (visible in edit mode) -->
                                <Border Grid.Row="0"
                                        BackgroundColor="{StaticResource SystemRed}"
                                        StrokeThickness="0"
                                        HeightRequest="24"
                                        WidthRequest="24"
                                        HorizontalOptions="End"
                                        VerticalOptions="Start"
                                        Margin="-4,-4,0,0"
                                        IsVisible="{Binding Source={RelativeSource AncestorType={x:Type vm:ShortcutsViewModel}}, Path=IsEditing}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12" />
                                    </Border.StrokeShape>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ShortcutsViewModel}}, Path=DeleteShortcutCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                    <Label Text="✕"
                                           TextColor="White"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                                </Border>
                            </Grid>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Editor Modal Overlay -->
        <Grid IsVisible="{Binding IsEditorVisible}"
              BackgroundColor="{AppThemeBinding Light=#80F2F2F7, Dark=#80000000}"
              InputTransparent="False">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseEditorCommand}" />
            </Grid.GestureRecognizers>

            <!-- Step 1: Select Channel -->
            <Frame Style="{StaticResource CardFrame}"
                   VerticalOptions="Center"
                   HorizontalOptions="Center"
                   WidthRequest="{OnIdiom Phone=340, Default=450}"
                   MaximumHeightRequest="500"
                   Padding="20"
                   IsVisible="{Binding EditorStep, Converter={toolkit:IsEqualConverter}, ConverterParameter=1}">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer />
                </Frame.GestureRecognizers>

                <Grid RowDefinitions="Auto,*,Auto" RowSpacing="16">
                    <Label Grid.Row="0"
                           Text="Select a Channel"
                           Style="{StaticResource TitleLabel}"
                           HorizontalOptions="Center" />

                    <!-- Loading indicator -->
                    <ActivityIndicator Grid.Row="1"
                                       IsRunning="{Binding IsLoadingChannels}"
                                       IsVisible="{Binding IsLoadingChannels}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />

                    <!-- Channel Grid -->
                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding AvailableChannels}"
                                    IsVisible="{Binding IsLoadingChannels, Converter={toolkit:InvertedBoolConverter}}">
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout Orientation="Vertical"
                                             Span="{OnIdiom Phone=3, Default=4}"
                                             HorizontalItemSpacing="8"
                                             VerticalItemSpacing="8" />
                        </CollectionView.ItemsLayout>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RokuChannel">
                                <Frame BackgroundColor="{AppThemeBinding Light={StaticResource SystemFillLight}, Dark={StaticResource SystemFillDark}}"
                                       CornerRadius="12"
                                       Padding="8"
                                       HeightRequest="80"
                                       HasShadow="False"
                                       BorderColor="Transparent">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ShortcutsViewModel}}, Path=SelectChannelCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Frame.GestureRecognizers>

                                    <VerticalStackLayout Spacing="4" VerticalOptions="Center">
                                        <Border StrokeThickness="0"
                                                HeightRequest="40"
                                                WidthRequest="40"
                                                HorizontalOptions="Center">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="8" />
                                            </Border.StrokeShape>
                                            <Image Source="{Binding IconUrl}"
                                                   Aspect="AspectFit" />
                                        </Border>
                                        <Label Text="{Binding Name}"
                                               Style="{StaticResource CaptionLabel}"
                                               HorizontalOptions="Center"
                                               MaxLines="1"
                                               LineBreakMode="TailTruncation" />
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Cancel Button -->
                    <Button Grid.Row="2"
                            Text="Cancel"
                            Command="{Binding CloseEditorCommand}"
                            Style="{StaticResource SecondaryButton}"
                            HorizontalOptions="Center"
                            WidthRequest="120"
                            HeightRequest="44" />
                </Grid>
            </Frame>

            <!-- Step 2: Name and Save -->
            <Frame Style="{StaticResource CardFrame}"
                   VerticalOptions="Center"
                   HorizontalOptions="Center"
                   WidthRequest="340"
                   Padding="24"
                   IsVisible="{Binding EditorStep, Converter={toolkit:IsEqualConverter}, ConverterParameter=2}">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer />
                </Frame.GestureRecognizers>

                <VerticalStackLayout Spacing="20">
                    <Label Text="Name Your Shortcut"
                           Style="{StaticResource TitleLabel}"
                           HorizontalOptions="Center" />

                    <!-- Selected Channel Preview -->
                    <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                        <Border StrokeThickness="0"
                                HeightRequest="56"
                                WidthRequest="56">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>
                            <Image Source="{Binding SelectedChannel.IconUrl}"
                                   Aspect="AspectFit" />
                        </Border>
                        <Label Text="{Binding SelectedChannel.Name}"
                               Style="{StaticResource BodyLabel}"
                               VerticalOptions="Center"
                               FontAttributes="Bold" />
                    </HorizontalStackLayout>

                    <!-- Name Entry -->
                    <Entry Placeholder="Shortcut name"
                           Text="{Binding NewShortcutName}"
                           ReturnCommand="{Binding SaveShortcutCommand}"
                           ReturnType="Done" />

                    <!-- Buttons -->
                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                        <Button Grid.Column="0"
                                Text="Back"
                                Command="{Binding BackToChannelSelectionCommand}"
                                Style="{StaticResource SecondaryButton}"
                                WidthRequest="80"
                                HeightRequest="44" />
                        <Button Grid.Column="1"
                                Text="Save"
                                Command="{Binding SaveShortcutCommand}"
                                Style="{StaticResource PrimaryButton}"
                                HeightRequest="44" />
                        <Button Grid.Column="2"
                                Text="Cancel"
                                Command="{Binding CloseEditorCommand}"
                                Style="{StaticResource SecondaryButton}"
                                WidthRequest="80"
                                HeightRequest="44" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>
