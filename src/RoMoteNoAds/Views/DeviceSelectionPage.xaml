<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RoMoteNoAds.ViewModels"
             xmlns:models="clr-namespace:RoMoteNoAds.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="RoMoteNoAds.Views.DeviceSelectionPage"
             x:DataType="vm:DeviceSelectionViewModel"
             Title="Devices"
             BackgroundColor="{AppThemeBinding Light={StaticResource SystemGroupedBackgroundLight}, Dark={StaticResource SystemGroupedBackgroundDark}}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Scan"
                     Command="{Binding ScanForDevicesCommand}"
                     IconImageSource="magnifyingglass" />
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Spacing="0"
                             Padding="{OnIdiom Phone='16', Default='24'}">

            <!-- Error Message -->
            <Border BackgroundColor="{StaticResource SystemRed}"
                    Padding="12,8"
                    StrokeShape="RoundRectangle 8"
                    Margin="0,0,0,16"
                    IsVisible="{Binding ErrorMessage, Converter={toolkit:IsStringNotNullOrEmptyConverter}}">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="White"
                       FontSize="13"
                       HorizontalOptions="Center" />
            </Border>

            <!-- Scanning Progress -->
            <Frame Style="{StaticResource CardFrame}"
                   Margin="0,0,0,16"
                   IsVisible="{Binding IsScanning}">
                <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                    <ActivityIndicator IsRunning="{Binding IsScanning}"
                                       HeightRequest="20"
                                       WidthRequest="20" />
                    <Label Text="Scanning for Roku devices..."
                           Style="{StaticResource BodyLabel}" />
                </HorizontalStackLayout>
            </Frame>

            <!-- Section: My Devices -->
            <Label Text="MY DEVICES"
                   Style="{StaticResource GroupedListHeader}" />

            <!-- Devices List (grouped card style) -->
            <Frame Style="{StaticResource GroupedCard}"
                   IsVisible="{Binding HasDevices}">
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Devices}"
                                     Spacing="0">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:RokuDevice">
                            <SwipeView>
                                <SwipeView.RightItems>
                                    <SwipeItems>
                                        <SwipeItem Text="Delete"
                                                   BackgroundColor="{StaticResource SystemRed}"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DeviceSelectionViewModel}}, Path=RemoveDeviceCommand}"
                                                   CommandParameter="{Binding .}" />
                                    </SwipeItems>
                                </SwipeView.RightItems>

                                <Grid Padding="16,12"
                                      ColumnDefinitions="Auto,*,Auto"
                                      ColumnSpacing="12"
                                      BackgroundColor="{AppThemeBinding Light={StaticResource SecondarySystemGroupedBackgroundLight}, Dark={StaticResource SecondarySystemGroupedBackgroundDark}}">
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DeviceSelectionViewModel}}, Path=SelectDeviceCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>

                                    <!-- Device Icon -->
                                    <Border Grid.Column="0"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource SystemFillLight}, Dark={StaticResource SystemFillDark}}"
                                            StrokeThickness="0"
                                            HeightRequest="44"
                                            WidthRequest="44"
                                            VerticalOptions="Center">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="10" />
                                        </Border.StrokeShape>
                                        <Label Text="ðŸ“º"
                                               FontSize="22"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Border>

                                    <!-- Device Info -->
                                    <VerticalStackLayout Grid.Column="1"
                                                         VerticalOptions="Center"
                                                         Spacing="2">
                                        <Label Text="{Binding DisplayName}"
                                               Style="{StaticResource BodyLabel}"
                                               FontAttributes="Bold" />
                                        <Label Style="{StaticResource SubtitleLabel}">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding ModelName}" />
                                                    <Span Text=" â€¢ " />
                                                    <Span Text="{Binding IpAddress}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </VerticalStackLayout>

                                    <!-- Selection Indicator -->
                                    <Label Grid.Column="2"
                                           Text="âœ“"
                                           TextColor="{StaticResource AccentColor}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding IsSelected}" />
                                </Grid>
                            </SwipeView>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>
            </Frame>

            <!-- Empty State -->
            <Frame Style="{StaticResource CardFrame}"
                   IsVisible="{Binding HasDevices, Converter={toolkit:InvertedBoolConverter}}"
                   Padding="24">
                <VerticalStackLayout Spacing="12" HorizontalOptions="Center">
                    <Label Text="ðŸ“¡"
                           FontSize="48"
                           HorizontalOptions="Center" />
                    <Label Text="No Devices Found"
                           Style="{StaticResource HeadlineLabel}"
                           HorizontalOptions="Center" />
                    <Label Text="Tap 'Scan' to find Roku devices on your network, or add one manually below."
                           Style="{StaticResource SubtitleLabel}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center" />
                </VerticalStackLayout>
            </Frame>

            <!-- Section: Add Device -->
            <Label Text="ADD DEVICE"
                   Style="{StaticResource GroupedListHeader}" />

            <Frame Style="{StaticResource GroupedCard}" Padding="16">
                <VerticalStackLayout Spacing="16">
                    <!-- Manual IP Entry -->
                    <VerticalStackLayout Spacing="8">
                        <Label Text="IP Address"
                               Style="{StaticResource CaptionLabel}" />
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <Entry Grid.Column="0"
                                   Placeholder="192.168.1.100"
                                   Text="{Binding ManualIpAddress}"
                                   Keyboard="Numeric"
                                   ReturnCommand="{Binding AddManualDeviceCommand}"
                                   ClearButtonVisibility="WhileEditing" />
                            <Button Grid.Column="1"
                                    Text="Add"
                                    Command="{Binding AddManualDeviceCommand}"
                                    Style="{StaticResource PrimaryButton}"
                                    WidthRequest="80"
                                    HeightRequest="44"
                                    IsEnabled="{Binding IsBusy, Converter={toolkit:InvertedBoolConverter}}" />
                        </Grid>
                    </VerticalStackLayout>

                    <!-- Separator -->
                    <BoxView HeightRequest="1"
                             Color="{AppThemeBinding Light={StaticResource SeparatorLight}, Dark={StaticResource SeparatorDark}}" />

                    <!-- Scan Button -->
                    <Button Text="{Binding IsScanning, Converter={toolkit:BoolToObjectConverter TrueObject='Scanning...', FalseObject='Scan Network'}}"
                            Command="{Binding ScanForDevicesCommand}"
                            Style="{StaticResource SecondaryButton}"
                            IsEnabled="{Binding IsScanning, Converter={toolkit:InvertedBoolConverter}}" />
                </VerticalStackLayout>
            </Frame>

            <!-- Footer Note -->
            <Label Text="Swipe left on a device to remove it from your list."
                   Style="{StaticResource FootnoteLabel}"
                   HorizontalOptions="Center"
                   Margin="0,16,0,0" />

            <!-- Loading Overlay -->
            <Grid IsVisible="{Binding IsBusy}"
                  BackgroundColor="{AppThemeBinding Light=#80F2F2F7, Dark=#80000000}"
                  HeightRequest="100"
                  Margin="0,16,0,0">
                <VerticalStackLayout VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Spacing="12">
                    <ActivityIndicator IsRunning="{Binding IsBusy}"
                                       HeightRequest="30"
                                       WidthRequest="30" />
                    <Label Text="Connecting..."
                           Style="{StaticResource SubtitleLabel}"
                           HorizontalOptions="Center" />
                </VerticalStackLayout>
            </Grid>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
