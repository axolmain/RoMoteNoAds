<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:RoMoteNoAds.ViewModels"
             xmlns:models="clr-namespace:RoMoteNoAds.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="RoMoteNoAds.Views.DeviceSelectionPage"
             x:DataType="vm:DeviceSelectionViewModel"
             Title="Devices">

    <Grid RowDefinitions="Auto,*,Auto" Padding="16">

        <!-- Header with error -->
        <VerticalStackLayout Grid.Row="0" Spacing="8">
            <Label Text="Roku Devices"
                   Style="{StaticResource TitleLabel}" />
            <Label Text="Select a device to control"
                   Style="{StaticResource SubtitleLabel}" />

            <!-- Error Message -->
            <Border BackgroundColor="{StaticResource Error}"
                   Padding="12,8"
                   IsVisible="{Binding ErrorMessage, Converter={toolkit:IsStringNotNullOrEmptyConverter}}">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="White"
                       FontSize="12"
                       HorizontalOptions="Center" />
            </Border>
        </VerticalStackLayout>

        <!-- Device List -->
        <CollectionView Grid.Row="1"
                       ItemsSource="{Binding Devices}"
                       Margin="0,16,0,0">
            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center"
                                    HorizontalOptions="Center"
                                    Spacing="16">
                    <Label Text="No Devices Found"
                           Style="{StaticResource TitleLabel}"
                           HorizontalOptions="Center" />
                    <Label Text="Tap 'Scan' to find Roku devices on your network"
                           Style="{StaticResource SubtitleLabel}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:RokuDevice">
                    <SwipeView>
                        <SwipeView.RightItems>
                            <SwipeItems>
                                <SwipeItem Text="Delete"
                                          BackgroundColor="{StaticResource Error}"
                                          Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DeviceSelectionViewModel}}, Path=RemoveDeviceCommand}"
                                          CommandParameter="{Binding .}" />
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <Frame Style="{StaticResource CardFrame}"
                               Margin="0,6"
                               BorderColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DeviceSelectionViewModel}}, Path=SelectDeviceCommand}"
                                    CommandParameter="{Binding .}" />
                            </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">
                                <!-- Device Name -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding DisplayName}"
                                       Style="{StaticResource BodyLabel}"
                                       FontAttributes="Bold"
                                       FontSize="16" />

                                <!-- Selected Indicator -->
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="✓ Connected"
                                       TextColor="{StaticResource Success}"
                                       FontSize="12"
                                       IsVisible="{Binding IsSelected}"
                                       VerticalOptions="Center" />

                                <!-- Model Info -->
                                <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="{Binding ModelName}"
                                       Style="{StaticResource SubtitleLabel}" />

                                <!-- IP Address and Device Type -->
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                                      Spacing="8">
                                    <Label Text="{Binding IpAddress}"
                                           Style="{StaticResource SubtitleLabel}"
                                           FontSize="12" />
                                    <Label Text="•"
                                           Style="{StaticResource SubtitleLabel}"
                                           FontSize="12" />
                                    <Label Text="{Binding IsTv, StringFormat='{0:Roku TV;Roku TV;Streaming Device}'}"
                                           Style="{StaticResource SubtitleLabel}"
                                           FontSize="12" />
                                </HorizontalStackLayout>
                            </Grid>
                        </Frame>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Bottom Actions -->
        <VerticalStackLayout Grid.Row="2" Spacing="12">
            <!-- Manual IP Entry -->
            <Frame Style="{StaticResource CardFrame}" Padding="12">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <Entry Grid.Column="0"
                           Placeholder="Enter IP address (e.g., 192.168.1.100)"
                           Text="{Binding ManualIpAddress}"
                           Keyboard="Numeric"
                           ReturnCommand="{Binding AddManualDeviceCommand}" />
                    <Button Grid.Column="1"
                            Text="Add"
                            Command="{Binding AddManualDeviceCommand}"
                            Style="{StaticResource PrimaryButton}"
                            WidthRequest="80"
                            IsEnabled="{Binding IsBusy, Converter={toolkit:InvertedBoolConverter}}" />
                </Grid>
            </Frame>

            <!-- Scan Button -->
            <Button Text="{Binding IsScanning, Converter={toolkit:BoolToObjectConverter TrueObject='Scanning...', FalseObject='Scan for Devices'}}"
                    Command="{Binding ScanForDevicesCommand}"
                    Style="{StaticResource PrimaryButton}"
                    IsEnabled="{Binding IsScanning, Converter={toolkit:InvertedBoolConverter}}" />
        </VerticalStackLayout>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding IsBusy}"
              BackgroundColor="{AppThemeBinding Light=#80FFFFFF, Dark=#80000000}">
            <VerticalStackLayout VerticalOptions="Center"
                                HorizontalOptions="Center"
                                Spacing="16">
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                  HeightRequest="50"
                                  WidthRequest="50" />
                <Label Text="Connecting..."
                       Style="{StaticResource BodyLabel}"
                       HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Grid>

        <!-- Scanning Indicator -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding IsScanning}"
              BackgroundColor="{AppThemeBinding Light=#80FFFFFF, Dark=#80000000}"
              InputTransparent="True">
            <VerticalStackLayout VerticalOptions="Center"
                                HorizontalOptions="Center"
                                Spacing="16">
                <ActivityIndicator IsRunning="{Binding IsScanning}"
                                  HeightRequest="50"
                                  WidthRequest="50" />
                <Label Text="Scanning for Roku devices..."
                       Style="{StaticResource BodyLabel}"
                       HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
